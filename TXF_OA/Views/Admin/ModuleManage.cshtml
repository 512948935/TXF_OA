@{
    ViewBag.Title = "系统模块管理";
}
<div id="div_layout" class="easyui-layout" style="width:100%;height:100%">
    <!------------------------------左部-----------------------------> 
    <div data-options="region:'west',split:true,tools:'#toolbar',collapsible:false" iconCls='tu1419' title="系统菜单" id="left" style="width:250px;padding:5px">
        <ul id="ul_tree"></ul>
        <!----------------------------------模块编辑对话框------------------------------------------->
        <div id="div_dialog_edit" style="padding:2px;top:30%;width:350px">
           <form id="form_edit" method="post" action="">
               <table id="tt" class="tablestyle" align="center" width="100%" border="0" cellpadding="0" cellspacing="0">            
                <tr>
                    <td class="td1" width="40%">模块代码：</td>
                    <td class="td2">
                        <input type="text" id="t_ModuleCode" name="ModuleCode" required="true" missingMessage='必填' />
                        <input type="hidden" id="t_ID" name="ID" value="0" />
                        <input type="hidden" id="t_PreCode" name="PreCode" />
                    </td>
                </tr>
                <tr>
                    <td class="td1">模块名称：</td>
                    <td class="td2">
                        <input type="text" id="t_ModuleName" name="ModuleName" required="true" missingMessage='必填' />
                    </td>
                </tr>
                <tr>
                    <td class="td1">模块图标：</td>
                    <td class="td2"><input id="t_Icon" name="Icon"/></td>
                </tr>
                <tr>
                    <td class="td1">是否禁用：</td>
                    <td class="td2">
                        <input type="checkbox" class="checkbox" id="t_IsDisabled" name="IsDisabled" value="true" />
                    </td>
                </tr>
                </table>    
         </form>
        <!--树形头部菜单-->
        <div id="toolbar">
             <a href="javascript:void(0)" class="icon-add" id="btnAdd"></a>
             <a href="javascript:void(0)" class="icon-edit" onclick="javascript:$('#btnModify').click();"></a>
             <a href="javascript:void(0)" class="icon-cut" onclick="javascript:$('#btnDel').click();"></a>
         </div>
        <!--树形右键菜单-->
        <div id="div_menu" class="easyui-menu" style="width:120px;">
            <div id="btnModify" iconCls='icon-edit'" >修改节点</div>
		    <div id="btnDel" iconCls='icon-remove'">删除节点</div>
            <div class="menu-sep"></div>
		    <div iconCls='tu0103'>折叠节点</div>
            <div iconCls='tu0203'>展开节点</div>
            <div></div>
	     </div> 
	 </div>
     </div>
    <!--------------------------------------中间----------------------------------> 
    <div data-options="region:'center'" title="页面信息" iconCls='tu1602'>
        <!------------------------------------列表数据展示------------------------------------------->
        <table class="easyui-datagrid" id="tt_grid" name="datagrid" width="100%" border="0"
               data-options="url:url,
                             fit:true,
                             rowStyler:rowstyler,
                             toolbar:toolbar">
                <thead data-options="frozen:true">
                    <tr>
                        <th data-options="field:'ck',checkbox:true"></th>
                        <th data-options="field:'ID',hidden:true,title:'ID'"></th>
                    </tr>
                </thead>
                <thead>
                    <tr>
                        <th data-options="field:'ModuleCode',align:'center',sortable:'true',where:'true'">页面代码</th>
                        <th data-options="field:'ModuleName',where:'true'">页面名称</th>
                        <th data-options="field:'PageUrl'">链接地址</th>
                        <th data-options="field:'Icon'">页面图标</th>
                        <th data-options="field:'IsDisabled',align:'center',formatter:boolFormatter">是否禁用</th>
                    </tr>
                </thead>
        </table>
        <div id="div_dialog_icon" style="padding:2px;width:477px;height:350px"></div>
        <div id="div_dialog_search" style="padding:2px;width:350px;top:30%"></div>
        <div id="div_win_edit" style="padding:2px;overflow:hidden;width:77%;height:99%;left:253px"></div>
     </div>
</div>
<script type="text/javascript">
    //#region easyui-datagrid 功能按钮+配置参数
    var url = "/Admin/GetPageList";
    var selectedID;
    var toolbar = [{
        id: 'btnadd',
        text: '添加',
        iconCls: 'icon-add',
        handler: function () {
            //子窗体的form
            selectedID = 0;
            $('#div_win_edit').window('open');
        }
    }, '-', {
        id: 'btnedit',
        text: '修改',
        iconCls: 'icon-edit',
        handler: function () {
            var selections = $('#tt_grid').datagrid('getSelections');
            if (selections.length == 1) {
                selectedID = selections[0].ID;
                $('#div_win_edit').window('open');
            }
            else
                jqAlert('请选择一条记录！', 'warning')
        }
    }, '-', {
        id: 'btnremove',
        text: '删除',
        iconCls: 'icon-remove',
        handler: function () {
            var selections = $('#tt_grid').datagrid('getSelections');
            if (selections.length == 0)
                jqAlert('请选择一条记录！', 'warning')
            else {
                var id = "(";
                for (var i = 0; i < selections.length; i++) {
                    id += selections[i].ID + ",";
                }
                id += "-1)";
                uiConfirm("您确认要删除当前信息吗.", function () {
                    $.post("/Admin/DeleteAction", { "ID": id }, function (data) {
                        if (data.status == 1) {
                            $("#tt_grid").datagrid('reload');
                        }
                        else
                            jqAlert('删除失败:' + data, 'error')
                    });
                });
            }
        }
    }, '-', {
        id: 'btnsearch',
        text: '查询',
        iconCls: 'icon-search',
        handler: function () {
            $('#div_dialog_search').dialog('open');
        }
    }];
    var boolFormatter = function (value) {
        if (value == "True") return "是"
        return "否";
    }
    var rowstyler = function (index, row) {
        if (row.IsDisabled == "True") {
            return 'color:#FF0000';
        }
    }
    //#endregion

    //#region 加载事件
    $(function () {
        //调整布局大小
        $("#body_layout").layout('panel', 'center').panel({
            onResize: function (width, height) {
                $("[name=datagrid]").datagrid("resize", width);
            }
        });
        //添加textbox样式
        $("#form_edit input:text").each(function () {
            $(this).addClass('easyui-validatebox textbox txt');
            if ($(this).attr('required') || $(this).attr('validtype'))
                $(this).validatebox();
        });
        $("#t_Icon").textbox({
            prompt: '双击我选择图标哦.',
            buttonIcon: 'icon-clear',
            onClickButton: function () {
                $(this).textbox('clear')
            }
        });
        //配置树形控件
        $('#ul_tree').tree({
            url: '/Admin/LoadTree',
            animate: true,
            lines: true,
            onLoadError: function () { alert("信息获取失败.") },
            onContextMenu: function (e, node) {
                e.preventDefault();
                $(this).tree('select', node.target);
                $('#div_menu').menu({
                    onClick: function (item) {
                        var isLeaf = $(this).tree('isLeaf', node.target);
                        if (!isLeaf) {
                            if (item.text == "展开节点") {
                                $.post('/Admin/SetNodeState', { state: 'open', id: node.id }, function () {
                                    $("#ul_tree").tree("reload");
                                });
                            }
                            if (item.text == "折叠节点") {
                                $.post('/Admin/SetNodeState', { state: 'closed', id: node.id }, function () {
                                    $("#ul_tree").tree("reload");
                                });
                            }
                        }
                    }
                });
                $('#div_menu').menu('show', { left: e.pageX, top: e.pageY });
            },
            formatter: function (node) {
                if (node.attributes["IsDisabled"] == "True")
                    return "<span style='color:red'>" + node.text + "</span>";
                return node.text;
            },
            onLoadSuccess: function () {
                var node = $('#ul_tree').tree('find', $("#t_ID").val());
                if (node != null)
                    $('#ul_tree').tree('select', node.target);
            },
            onSelect: function (node) {
                var code = node.attributes["ModuleCode"];
                if (code != $("#t_PreCode").val()) {
                    $('#tt_grid').datagrid('options').url = '/Admin/GetPageList?code=' + code;
                    $("#tt_grid").datagrid('load');
                    $("#t_PreCode").val(code);
                }
            }
        });
        //新增节点
        $("#btnAdd").click(function () {
            $("#t_ID").val(0);
            $("#form_edit")[0].reset(); //重置表单
            $('#div_dialog_edit').dialog('open');
        });
        //修改节点
        $("#btnModify").click(function () {
            var node = $("#ul_tree").tree("getSelected");
            if (node == null)
                jqAlert('请选择需要修改的模块名称.', 'warning');
            else {
                //表单赋值
                var attrValue = node.attributes;
                $("#form_edit").find("input").each(function () {
                    if (this.type == "text" || this.type == "hidden")
                        $(this).val(attrValue[this.name]);
                    else if (this.type == "checkbox")
                        $(this).attr("checked", attrValue == "True");
                });
                $("#t_Icon").textbox("setValue", attrValue.Icon);
                $("#t_PreCode").val(node.attributes["ModuleCode"]);
                $('#div_dialog_edit').dialog('open');
            }
        });
        //删除节点
        $("#btnDel").click(function () {
            var node = $("#ul_tree").tree("getSelected");
            if (node == null)
                jqAlert('请选择需要删除的模块名称.', 'warning');
            else {
                uiConfirm("确定要删除当前模块吗！", function () {
                    var postData = { "code": eval(node.attributes).ModuleCode };
                    $.post("/Admin/DeleteModule", postData, function (data) {
                        if (data.status == 1) {//删除成功
                            $("#ul_tree").tree("reload");
                        }
                        else
                            jqAlert('删除失败:' + data, 'error')
                    });
                });
            }
        });
        //初始化模块编辑对话框
        showMyDialog($("#div_dialog_edit"), '编辑模块信息', 'icon-edit', '', true, function () {
            if ($("#form_edit").form('validate')) {
                $.ajaxPost({
                    url: "/Admin/SaveAction",
                    data: $("#form_edit").serializeArray(),
                    success: function (data) {
                        if (data.status == 1) {//保存成功
                            $("#div_dialog_edit").dialog('close');
                            $("#ul_tree").tree("reload");
                        }
                        else
                            jqAlert('保存失败:' + data, 'error')
                    }
                });
            }
        });
        //图标选择对话框
        var selectedIcon;
        showMyDialog($("#div_dialog_icon"), '页面图标', 'tu0511', "/Admin/CreateButtonIcon", false, function () {
            $("#t_Icon").textbox("setValue", selectedIcon.title);
            $("#div_dialog_icon").window("close")
        }).dialog({
            onLoad: function () {
                $("#tt td a img").click(function () {
                    if (selectedIcon != null)
                        $(selectedIcon).css("border-color", "#fffffb");
                    $(this).css("border-color", "#ffd400");
                    selectedIcon = this;
                });
            }
        });
        var txt = $("#t_Icon").textbox("textbox");
        $(txt).dblclick(function () {
            $("#div_dialog_icon").dialog('open');
        });
        //初始化页面编辑对话框
        showMyWindow($("#div_win_edit"), '编辑页面信息', 'icon-edit', "", 'frame1', true, false, true).window({
            onOpen: function () {
                var src = "/Admin/ModuleEdit?ID=" + selectedID;
                if ($("#t_PreCode").val() != "")
                    src += "&Code=" + $("#t_PreCode").val() + ".";
                if ($("#frame1").attr("src") != src)
                    $("#frame1").attr("src", src);
            }
        })
        //初始化过滤查询对话框
        getWhereColumns($("#tt_grid"), function (col) {
            var href = '/Admin/CreateWhereHTML?col=' + col;
            showMyDialog($("#div_dialog_search"), '筛选条件', 'tu1611', href, true, function () {
                var where = "";
                $("#ttSearch input:text").each(function () {
                    where += '{Key:"' + $(this).attr('name') + '",Value:"' + $.strFilter($(this).val()) + '",Symbol:"like"},';
                });
                if (where != "") {
                    where = "[" + $.trimend(where, ',') + "]";
                    $('#tt_grid').datagrid('options').url = '/Admin/GetPageList?code=' + $("#t_PreCode").val() + '&where=' + escape(where);
                    $("#tt_grid").datagrid('load');
                    $('#div_dialog_search').dialog('close');
                }
            });
        });
    });
    //#endregion
</script>